<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.qianjisan.system.mapper.SysTrackingLogMapper">

    <!-- 统计埋点类型数量（按时间维度） -->
    <select id="statisticsByEventType" resultType="com.qianjisan.system.vo.EventTypeStatisticsVO">
        SELECT
        <choose>
            <when test="timeType == 'day'">
                DATE_FORMAT(create_time, '%Y-%m-%d') AS timeDimension,
            </when>
            <when test="timeType == 'month'">
                DATE_FORMAT(create_time, '%Y-%m') AS timeDimension,
            </when>
            <when test="timeType == 'year'">
                DATE_FORMAT(create_time, '%Y') AS timeDimension,
            </when>
            <otherwise>
                DATE_FORMAT(create_time, '%Y-%m-%d') AS timeDimension,
            </otherwise>
        </choose>
        event_type AS eventType,
        COUNT(*) AS count
        FROM tracking_log
        WHERE is_deleted = 0
        <if test="startTime != null and startTime != ''">
            AND create_time >= #{startTime}
        </if>
        <if test="endTime != null and endTime != ''">
            AND create_time &lt;= #{endTime}
        </if>
        GROUP BY
        <choose>
            <when test="timeType == 'day'">
                DATE_FORMAT(create_time, '%Y-%m-%d'), event_type
            </when>
            <when test="timeType == 'month'">
                DATE_FORMAT(create_time, '%Y-%m'), event_type
            </when>
            <when test="timeType == 'year'">
                DATE_FORMAT(create_time, '%Y'), event_type
            </when>
            <otherwise>
                DATE_FORMAT(create_time, '%Y-%m-%d'), event_type
            </otherwise>
        </choose>
        ORDER BY timeDimension ASC, eventType ASC
    </select>

    <!-- 统计用户活跃量（按时间维度） -->
    <select id="statisticsUserActivity" resultType="com.qianjisan.system.vo.UserActivityVO">
        SELECT
        <choose>
            <when test="timeType == 'day'">
                DATE_FORMAT(create_time, '%Y-%m-%d') AS timeDimension,
            </when>
            <when test="timeType == 'month'">
                DATE_FORMAT(create_time, '%Y-%m') AS timeDimension,
            </when>
            <when test="timeType == 'year'">
                DATE_FORMAT(create_time, '%Y') AS timeDimension,
            </when>
            <otherwise>
                DATE_FORMAT(create_time, '%Y-%m-%d') AS timeDimension,
            </otherwise>
        </choose>
        COUNT(DISTINCT user_id) AS activeUserCount,
        COUNT(*) AS totalCount
        FROM tracking_log
        WHERE is_deleted = 0
        AND user_id IS NOT NULL
        <if test="startTime != null and startTime != ''">
            AND create_time >= #{startTime}
        </if>
        <if test="endTime != null and endTime != ''">
            AND create_time &lt;= #{endTime}
        </if>
        GROUP BY
        <choose>
            <when test="timeType == 'day'">
                DATE_FORMAT(create_time, '%Y-%m-%d')
            </when>
            <when test="timeType == 'month'">
                DATE_FORMAT(create_time, '%Y-%m')
            </when>
            <when test="timeType == 'year'">
                DATE_FORMAT(create_time, '%Y')
            </when>
            <otherwise>
                DATE_FORMAT(create_time, '%Y-%m-%d')
            </otherwise>
        </choose>
        ORDER BY timeDimension ASC
    </select>

</mapper>



